name: Deploy Neo4j via SSH

on:
  workflow_call:
    inputs:
      SSH_HOST:
        description: 'Override for SSH_HOST variable'
        required: false
        type: string
      service_name:
        description: 'Service name for container naming (auto-detected from repo if not provided)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name }}
    env:
      NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}

    steps:
      - name: Set service configuration
        id: set_config
        run: |
          SERVICE_NAME="${{ inputs.service_name }}"
          if [ -z "$SERVICE_NAME" ]; then
            SERVICE_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          fi
          echo "service_name=$SERVICE_NAME" >> "$GITHUB_OUTPUT"

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.4.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add SSH host key
        run: ssh-keyscan "${{ inputs.SSH_HOST || vars.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy Neo4j container via SSH
        run: |
          if [ -z "${{ env.NEO4J_PASSWORD }}" ]; then
            echo "::error::NEO4J_PASSWORD is empty. Aborting deployment."
            exit 1
          fi

          ssh -p "${{ vars.SSH_PORT }}" -o StrictHostKeyChecking=no "${{ vars.SSH_USER }}"@"${{ inputs.SSH_HOST || vars.SSH_HOST }}" bash << 'EOF'
            SERVICE_NAME="${{ steps.set_config.outputs.service_name }}"
            CONTAINER_NAME="neo4j_${SERVICE_NAME}"

            if docker ps -a --format '{{.Names}}' | grep -qw "$CONTAINER_NAME"; then
              echo "Neo4j container exists â€” forcing password reset"

              # Stop container
              docker stop $CONTAINER_NAME || true

              # Mount config and disable auth
              docker run --rm \
                -v neo4j_home_${SERVICE_NAME}:/var/lib/neo4j \
                neo4j:latest sh -c "echo 'dbms.security.auth_enabled=false' >> /var/lib/neo4j/conf/neo4j.conf"

              # Restart container with disabled auth
              docker start $CONTAINER_NAME

              # Wait for DB to start
              until docker logs $CONTAINER_NAME 2>&1 | grep -q "Bolt enabled"; do sleep 1; done

              # Change password directly via cypher-shell
              docker exec $CONTAINER_NAME bin/cypher-shell -u neo4j -d system \
                "ALTER USER neo4j SET PASSWORD '${{ vars.NEO4J_PASSWORD }}';"

              # Stop container again
              docker stop $CONTAINER_NAME

              # Re-enable auth
              docker run --rm \
                -v neo4j_home_${SERVICE_NAME}:/var/lib/neo4j \
                neo4j:latest sh -c "sed -i '/dbms.security.auth_enabled=false/d' /var/lib/neo4j/conf/neo4j.conf"

              # Start normally
              docker start $CONTAINER_NAME
            else
              echo "Deploy new Neo4j container"

              # Create service-specific network (for app + db communication)
              SERVICE_NETWORK="network_${SERVICE_NAME}"
              docker network create "$SERVICE_NETWORK" 2>/dev/null || true

              mkdir -p /opt/neo4j/${SERVICE_NAME}/data
              docker run -d \
                --name $CONTAINER_NAME \
                --network $SERVICE_NETWORK \
                -v /opt/neo4j/${SERVICE_NAME}/data:/data \
                -e "NEO4J_AUTH=neo4j/${{ env.NEO4J_PASSWORD }}" \
                neo4j:latest
            fi
          EOF

      - name: Show Neo4j status on server
        run: |
          ssh -p "${{ vars.SSH_PORT }}" -o StrictHostKeyChecking=no "${{ vars.SSH_USER }}"@"${{ inputs.SSH_HOST || vars.SSH_HOST }}" \
            "docker ps --filter name=neo4j --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'"
