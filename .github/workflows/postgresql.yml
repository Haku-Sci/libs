name: Deploy PostgreSQL via SSH

on:
  workflow_call:
    inputs:
      SSH_HOST:
        description: 'Override for SSH_HOST variable'
        required: false
        type: string
      service_name:
        description: 'Service name for container naming (auto-detected from repo if not provided)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name }}
    env:
      POSTGRES_ADMIN: ${{ vars.POSTGRESQL_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRESQL_PASSWORD }}
      DB_NAME: ${{ github.event.repository.name }}
    steps:
      - name: Set service configuration
        id: set_config
        run: |
          SERVICE_NAME="${{ inputs.service_name }}"
          if [ -z "$SERVICE_NAME" ]; then
            SERVICE_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          fi
          echo "service_name=$SERVICE_NAME" >> "$GITHUB_OUTPUT"

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.4.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy PostgreSQL container via SSH
        run: |
          ssh -p ${{ vars.SSH_PORT }} -o StrictHostKeyChecking=no -o ServerAliveInterval=10 -o ServerAliveCountMax=3 ${{ vars.SSH_USER }}@${{ inputs.SSH_HOST || vars.SSH_HOST }} bash << 'EOF'
            SERVICE_NAME="${{ steps.set_config.outputs.service_name }}"
            CONTAINER_NAME="postgresql_${SERVICE_NAME}"

            # Stop & remove existing container
            if docker ps -a --format '{{.Names}}' | grep -qw "$CONTAINER_NAME"; then
              docker rm -f $CONTAINER_NAME || true
            fi

            # Create service-specific network (for app + db communication)
            SERVICE_NETWORK="network_${SERVICE_NAME}"
            docker network create "$SERVICE_NETWORK" 2>/dev/null || true

            # Ensure data directory exists
            mkdir -p /opt/postgres/${SERVICE_NAME}/data

            # Run PostgreSQL container with admin user/password and database
            docker run -d \
              --name $CONTAINER_NAME \
              --network $SERVICE_NETWORK \
              -v /opt/postgres/${SERVICE_NAME}/data:/var/lib/postgresql \
              -e POSTGRES_USER="${{ env.POSTGRES_ADMIN }}" \
              -e POSTGRES_PASSWORD="${{ env.POSTGRES_PASSWORD }}" \
              -e POSTGRES_DB="${{ env.DB_NAME }}" \
              postgres:18
            RC=$?
            if [ $RC -ne 0 ]; then
              docker logs $CONTAINER_NAME || true
              exit $RC
            fi

            echo "PostgreSQL container starting with name '$CONTAINER_NAME'."

            # Wait for PostgreSQL to be ready (max 60 seconds)
            TIMEOUT=60
            READY=false
            for i in $(seq 1 $TIMEOUT); do
              LOGS=$(docker logs $CONTAINER_NAME 2>&1)
              if echo "$LOGS" | grep -qi 'ready to accept connections'; then
                READY=true
                break
              fi
              if ! docker ps --format '{{.Names}}' | grep -qw "$CONTAINER_NAME"; then
                echo "ERROR: Container $CONTAINER_NAME stopped unexpectedly"
                docker logs $CONTAINER_NAME 2>&1
                exit 1
              fi
              sleep 1
            done

            if [ "$READY" != "true" ]; then
              echo "ERROR: PostgreSQL did not become ready within ${TIMEOUT}s"
              docker logs $CONTAINER_NAME 2>&1
              exit 1
            fi

            echo "PostgreSQL container started"

            # Set the password for the admin user
            docker exec $CONTAINER_NAME psql -h localhost -U "${{ env.POSTGRES_ADMIN }}" -d "${{ env.DB_NAME }}" -c "ALTER USER \"${{ env.POSTGRES_ADMIN }}\" WITH PASSWORD '${{ env.POSTGRES_PASSWORD }}';"
          EOF

      - name: Show PostgreSQL status on server
        run: |
          ssh -p ${{ vars.SSH_PORT }} -o StrictHostKeyChecking=no ${{ vars.SSH_USER }}@${{ inputs.SSH_HOST || vars.SSH_HOST }} \
            "docker ps --filter name=postgresql --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'"
