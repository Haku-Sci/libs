name: Deploy Caddy via SSH with generated Caddyfile
on:
  workflow_call:
    inputs:
      SSH_HOST:
        description: 'Override for SSH_HOST variable'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name }}
    steps:
      - name: Start ssh-agent
        uses: webfactory/ssh-agent@v0.4.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add SSH host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ vars.SSH_PORT }} ${{ inputs.SSH_HOST || vars.SSH_HOST }} 2>&1 | tee -a ~/.ssh/known_hosts

      - name: Generate Caddyfile
        run: |
          BRANCH="${{ github.ref_name }}"
          DOMAIN="${{ vars.DOMAIN_NAME }}"

          cat > /tmp/Caddyfile <<BLOCK
          # Auto-generated Caddyfile for branch: $BRANCH

          ${BRANCH}.${DOMAIN} {
              reverse_proxy app_front:8080
          }

          api.${BRANCH}.${DOMAIN} {
              reverse_proxy app_api:8080
          }

          collab.${BRANCH}.${DOMAIN} {
              reverse_proxy app_collab:8080
          }
          BLOCK

          echo "Generated Caddyfile:"
          cat /tmp/Caddyfile

      - name: Deploy Caddy container via SSH
        run: |
          HOST="${{ inputs.SSH_HOST || vars.SSH_HOST }}"
          PORT="${{ vars.SSH_PORT }}"
          USER="${{ vars.SSH_USER }}"

          scp -P $PORT /tmp/Caddyfile ${USER}@${HOST}:/tmp/Caddyfile

          ssh -p $PORT -o StrictHostKeyChecking=no ${USER}@${HOST} bash << 'EOF'
            if docker ps -a --format '{{.Names}}' | grep -qw "caddy"; then
              docker rm -f caddy
            fi
            mkdir -p /opt/caddy/config /opt/caddy/data
            mv /tmp/Caddyfile /opt/caddy/config/Caddyfile

            docker network create services 2>/dev/null || true

            docker run -d \
              --name caddy \
              --network services \
              -p 80:80 -p 443:443 \
              -v /opt/caddy/config/Caddyfile:/etc/caddy/Caddyfile:ro \
              -v /opt/caddy/data:/data \
              caddy:2-alpine
          EOF
